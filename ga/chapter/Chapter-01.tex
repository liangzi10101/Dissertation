\setcounter{chapter}{0}

\chapter{绪论}
\label{chap:Intro}

\section{课题研究背景及意义}

绘制系统的性能优化在实时渲染技术中有极其重要的研究意义和价值。在电子游戏、动画及虚拟现实等领域中，为了不断满足用户追求的画面真实感、沉浸感等，其绘制系统往往需要加入更多的计算机图形学算法，例如全局光照、物理仿真等绘制算法。而更多绘制算法的引入必然会造绘制系统性能的改变，这种改变一般情况下呈负面影响，也就是说会造成系统渲染性能的下降，因此，系统的性能优化也逐渐成为了该领域的研究热点。

绘制系统的性能优化往往可以从不同角度展开。目前为止，图形学领域对于绘制系统性能优化的研究大致可分为以下几个方面。

计算机图形学很重要的一个研究领域就是进行特定绘制算法自身优化的研究，通过完成对特定算法的优化，在保持甚至提高原有渲染效果的基础上，提高绘制效率。例如：基于级联纹理的圆锥追踪动态全局光照算法\cite{Crassin2011Interactive}，该算法进一步优化了全局光照算法，通过基于级联纹理的圆锥追踪近似模拟物体表面的BRDF光照计算模型，极大减简化了该公式的计算复杂度，从而加速全局光照算法的绘制效率。从算法本身进行优化最大的问题在于：该优化往往仅关注自身算法的优化过程，并不会进一步考虑结合多种算法的复杂绘制系统中，各个绘制算法之间是否存在相互影响或者相互重叠的部分，也就是说，该角度入手的优化方式对任意特定算法具有普适性，对绘制系统本身不具有普适性。

基于应用程序接口的优化可以解决上述问题，该角度不再将关注点放到某个特定的算法上，而是从更底层的算法调用的绘制指令等入手，完成对绘制性能的进一步优化。以OpenGL为例，OpenGL 是用于渲染2D、3D矢量图形的跨语言、跨平台图形库，它为图形的渲染工作管理着一套完整的绘制指令集合以及绘制状态，在不同的绘制状态下，各个绘制算法实际上是通过调用一系列绘制指令来真正执行完成绘制算法的，而实际情况是：不同的绘制算法之间很可能存在重叠的指令执行部分、冗余的绘制状态改变等，因此基于绘制指令集的优化通过进一步精简这些部分可以进一步解决这样的优化问题。然而，即使解决了上述问题仍然无法保证绘制系统已经不存在进一步优化的空间。其原因在于：该角度的优化默认各个绘制算法在逻辑上已经处于最优状态，但这几乎是不可能的。

举个简单的例子：假设一个渲染场景中需要完成某个位置的爆炸效果渲染，爆炸场景最终渲染的视觉效果假设由爆炸粒子的个数和爆炸粒子本身的半径正向决定，即：爆炸粒子个数越多、半径越大，爆炸效果越细腻。而事实上，当粒子个数达到一定数量时，爆炸效果在人眼的角度观察差别几乎不大，但此时粒子个数很可能已经严重影响到这个绘制算法的效率。而对于这种情况，通常是具有经验的图形开发者凭借经验进行调试优化。当系统仅包含单个算法或算法之间不存在相互影响时，这样的优化是简单有效的，但绘制系统逐渐复杂时，直观的经验可能无法给出进一步的优化指导。例如：如果在上述爆破场景中进一步引入半透明物体的渲染算法\cite{Maule2012Memory}，当场景中可见透明物体很少时，粒子个数或粒子半径仍然是影响绘制效率的瓶颈因素，但当场景中可见透明物体逐渐增加并达到一定阈值时，关于该透明算法的一些参数很可能已经超过爆破粒子个数和半径，成为了当前情况下的瓶颈因素。而随着系统引入算法的数量逐渐增加时，凭借经验给出指导优化变得尤其困难。类似像爆炸粒子个数、粒子半径和可见透明物体面积等这样在算法参数级别上影响系统绘制效率的因素我们称之为：算法级绘制参数。

算法级绘制参数的性能瓶颈识别技术能够很好的解决上述问题。该技术从算法逻辑参数的角度出发，旨在从算法层面寻找一种更通用的瓶颈识别方案：在给定的、载有多算法的绘制系统中，找到影响系统效率的算法级别的因素，从而帮助开发者进一步优化系统的绘制效率。

本课题基于算法级绘制参数的性能瓶颈识别技术，并以此作为研究切入点，在绘制系统满足指定渲染效果的前提下，针对该系统的实时性能，提出基于大数据分析的绘制系统性能瓶颈的自动识别方法，旨在利用数据挖掘的方法，基于绘制系统中绘制算法参数与绘制时间的关系模型，识别绘制系统中成为性能瓶颈的绘制算法参数，重点研究在无法识别到全局绘制性能瓶颈的情况下，通过特征空间划分实现各个子空间局部性能瓶颈的确定工作，进一步指导实时绘制系统的开发者：在满足绘制效果的前提下，如何调整绘制算法的参数，以获得高效的绘制效率。

除此之外，基于硬件的优化也是提高系统绘制性能的优化方案，但并不在本文讨论研究的范围之内。

\section{国内外研究现状}

对绘制系统的性能优化可以从上述多个角度进行展开，图形学研究者与图形软硬件开发商以不同的方式完成各自的研究，因此本节将从多个角度出发，介绍国内外绘制性能瓶颈识别技术的研究发展现状。由于图形学领域基于图形算法优化的内容因渲染目的各异且算法针对性强的特点，并不具有普适的讨论意义，因此本节并不会将其纳入到讨论范围内。本节更多的将着眼点放在基于应用程序接口级别的性能瓶颈识别与基于算法级别的性能瓶颈识别两大方面。

\subsection{基于应用程序接口级别的性能瓶颈识别}

图形硬件开发商特别是显卡制造厂商在提供高性能显卡硬件的同时，为了、最大限度提供图形硬件的底层支持、帮助开发人员进一步挖掘硬件提供的渲染性能，往往会配套开发出不同的性能分析工具，这些工具提供应用程序接口级别的调试、性能分析信息。

\subsubsection{Inter Graphics Performance Analysis 工具}

Inter Graphics Performance Analysis 工具\cite{InterGPA}是基于图形绘制的性能分析软件，它提供基于Inter HD Graphics （IHD）硬件平台下图形渲染的性能分析指导方案，通过其提供的一套应用程序接口，可视化、语言无关地给出开发人员在渲染过程中存在的性能问题\cite{OptimizeYourUnityGames}\cite{ApplicationsUsingIntel}，这里的语言无关是指：图形开发人员可以使用Microsoft 系统提供的Direct-X 语言、或者其他跨平台的图形开发库例如OpenGL 等，其给出的性能分析信息更多从底层的绘制指令接口角度出发，与载入的图形算法无关。

Inter Graphics Performance Analysis 工具大致包含如下功能组件：

\begin{itemize}
	\item Monitor：将Inter Graphics Performance Analysis 工具连接至用户的应用，为HUD （Head Up Display）模式以及键盘快捷键等完成配置工作；
	\item System Analyzer；实时查看CPU、GPU、 图形API 以及能源消耗指标，同时为绘制性能改进从指令集的角度给出简单的指导性建议；
	\item Platform Analyzer；将CPU 以及GPU 上承载的应用程序和其线程间的交互进行可视化管理；
    \item Graphics Frame Analyzer；完成单帧绘制结果的快照捕捉，并进行该帧内容的分析与指标显示，大致包含着色器、绘制状态、像素历史记录、纹理数据等信息的详细报告；
    \item Graphics Trace Analyzer；评估当前应用程序运行时，CPU 以及GPU 的工作负载性能，从而进一步保证在图形渲染过程中能够最大限度地发挥Inter HD Graphics 架构的处理能力；
\end{itemize}

近些年，越来越多的成熟商业应用构建在Inter HD Graphics（IHD）硬件平台架构上，并以Inter Graphics Performance Analysis 分析工具帮助完成了从研究到工业化的转型。在 Intel? GPA的支持下，在配置 Intel? 4系列高速芯片组显卡的机器上运行网络游戏《JX Online World 3》时，西山居研发团队进一步将该款游戏的整体可播放帧率提高了2.1倍\cite{JX3Game}。巨人网络研发团队通过 Intel? GPA 发现了游戏《King of Soldier》在绘制阴影，射击武器，施法念咒及角色的效果上的优化空间。在配置了第三代英特尔酷睿处理器的电脑上，《King of Soldier》的运行性能从图像密集型场景中的每秒12帧提高到了每秒21 帧\cite{OptimizingKingofSoldier}。《Xuanyuan Legend》是腾讯北极光工作室在2012年11 月发布的首款3D浅规则战斗网游，采用新一代国际顶级引擎Gamebryo Element 2.3\cite{GamebryoInfo}，辅以丰富的动态效果和光影效果，带来出色画面层次感。腾讯开发团队通过使用 Intel? GPA来分析代表性场景并找出瓶颈，该团队对阴影贴图生成，天空盒剔除，地形渲染， UI图像缓存以及缩小纹理进行了改进，通过这一系列渲染技术上的改进，完成了游戏绘制帧率从每秒53帧提高到71帧的提升\cite{OptimizingXuanYuan}，为用户提供出色的游戏体验。 针对Ubisoft团队开发的动作冒险游戏《Splinter Cell: Blacklist》，开发人员使用 Intel? GPA分析发现游戏中光照及阴影的绘制极大地影响了整体性能。经过优化改进后，这款游戏的帧率大约提高了3倍
\cite{OptimizingSplinterCellBlacklist}。 配置第四代英特尔酷睿 i7处理器的台式机，该款游戏的帧率分别达到了低配版的每秒43帧及中配版的每秒35帧。

\subsubsection{NVIDIA Nsight}

NVIDIA Nsight\cite{NVIDIANsight}\cite{GPUProgrammingGuideGeForce}\cite{NVIDIAParallelNsight}\cite{Nvidiaparallelnsighttm}是一个功能强大的调试及性能分析工具，它的强大主要表现在两大方面：帮助图形开发人员调试渲染应用程序，使其更好地理解代码、可视化观察系统行为活动；同时通过可视化的应用程序接口辅助开发人员了解程序使用CPU、GPU 的情况，便于开发人员分析和识别指令集性能瓶颈，为进一步的优化工作提供基础。

NVIDIA Nsight 是全球首个集成在 Microsoft Visual Studio 中的图形开发平台。NVIDIA Nsight Visual Studio Edition\cite{NVIDIANsightVisualStudioEdition}\cite{NVIDIANsightUserGuide}\cite{NVIDIANsightCUDA}是适用于在英伟达的GPU
上运行的CUDA(Compute Unified Device Architecture) 及图形应用程序的开发环境。借助 NVIDIA Nsight，开发人员可以在 Microsoft Visual Studio 中使用CUDA 调试器，图形调试器以及分析和配置工具，其具体功能如下：

\begin{itemize}
	\item CUDA Debugger: 帮助开发者调试 CUDA 应用程序，例如在 CUDA 源代码中设置断点，检查内存，查看本地变量的值以及执行其他常见的调试任务；
    \item Graphics Debugger: 允许开发人员通过指令操作捕捉帧并调试当前帧，例如调试顶点着色器，像素着色器以及查看管道情况；
    \item Analysis and Profiling Tools: 辅助开发人员了解工作负载在应用程序和整个系统中的分布，例如查看CUDA/OpenGL/DirectX 调用、内存拷贝、内核执行以及 CPU/GPU 活动事件。
\end{itemize}

NVIDIA Nsight应用于包括游戏开发，高性能计算\cite{DebuggingMassivelyParallelApplications}及超级计算等多个不同的领域。 BioWare艾德蒙顿工作室利用NVIDIA Nsight加速了游戏《Dragon Age 2》在GPU上的运行性能\cite{DragonAge}。对于安卓游戏《Space Ark》\cite{AndroidGameswithNVIDIA}，Strawdog Studios通过使用 NVIDIA Nsight Tegra 专为 NVIDIA Tegra 3以上的处理器进行了特别优化，其中，NVIDIA Nsight Tegra\cite{NVIDIANsightTegra}专用于开发、构建、调试和部署安卓系统原生应用程序。

\subsection{基于算法参数级别的性能瓶颈识别}

绘制算法一般包括多个特定的参数来控制算法中不同实现细节的绘制质量，例如在屏幕空间环境光遮蔽（Screen Space Ambient Occlusion，SSAO）\cite{Bavoil2009Multi}算法中，为计算遮挡率而采集每个像素周围深度样本的个数决定了环境光照的绘制质量，另外，用于模糊处理每个像素的滤波半径决定了去噪的质量。所有这些特定于算法的参数都可能与绘制系统的性能相关。因此，针对算法级别的性能瓶颈分析主要考虑各个绘制算法本身的内在因素对绘制性能的影响。

基于算法参数级别的性能瓶颈识别已经不再关注与底层对接的绘制接口调用部分，其将关注点更多的放在算法级别的参数对绘制效率的影响，该角度强调参数对结果的影响，而对算法普适，无论载入绘制系统的算法具体是什么，只要算法可以提供影响最终绘制效率的算法级参数，该思想就是有效的。

目前基于算法参数级别的性能瓶颈识别仍处在理论研究阶段，该领域需要更多的理论创新推动其不断发展。利用机器学习的思想解决该问题是一个非常重要的技术创新。其中有许多可以与本研究问题结合的部分。简言之，算法级参数可以抽象成机器学习思想中“特征”这一概念、绘制效率相应抽象成“学习结果”这一概念，通过衡量“特征”对“结果”的影响程度，从而确定出重要的“特征”，即：找到参数瓶颈。

\subsubsection{特征排序算法}

特征排序（Feature Ranking）是机器学习领域重要的应用分支，如何在多个特定于算法的参数中确定性能瓶颈这一问题可以转换为参数的特征排序。在机器学习和模式识别[31]中，特征是指独立的可衡量的属性或者是观察到的某一现象的特性，针对本研究问题，可以将某个算法参数抽象为一个“特征”，特征影响问题域的能力具体映射为算法参数影响绘制系统的能力，通过对该能力的排序最终识别出哪些算法参数会最终成为性能瓶颈。

特征排序是高层的抽象概念，可以通过不同的具体算法和排序准则完成，例如可以基于统计学、信息论或其他分类器的某些功能选择合理的排序准则来对特征进行评分。

在统计学上，皮尔森相关系数（Pearson Correlation Coefficient，PCC）\cite{10.2307/115794}\cite{article}是一种用来反映因变量与自变量之间线性相关程度的统计量。皮尔森系数的有效取值为[-1, 1]。 若皮尔森相关系数等于 0，表明因变量与自变量间非线性相关。若皮尔森相关系数大于 0，表明因变量与自变量是正相关；反之，则表明因变量与自变量是负相关。皮尔森相关系数的绝对值越大表明因变量与自变量间的相关性越强。

在概率论和信息论中，互信息（Mutual Information，MI）\cite{Chen1996Elements}\cite{Battiti1994Using}使用两个变量之间的依赖性度量作为排序准则。从概念上理解，互信息是一个变量包含另一个变量的信息量，换言之，已知一个变量，另外一个变量减少的信息量则为互信息。互信息是对偶且非负的，当其等于 0 时表示两个变量互不相关。不同于相关系数，互信息不仅能衡量两个变量线性相关的程度，还能衡量变量之间的非线性关系。

Jong 等人\cite{Scheffer2006Proceedings}受集成学习（Ensemble Learning）\cite{Breiman1998Arcing}的启发提出了集成特征排序（Ensemble Feature Ranking， EFR）。该算法使用了基于遗传算法的学习方法及进化学习算法 ROGER （ROC-based Genetic Learner）\cite{Sebag2003Impact}\cite{Sebag2003ROC}，在处理非线性问题时表现出了良好的性能。

Maldonado 等人\cite{Maldonado2014Feature}提出了基于线性支持向量机（Support Vector Machine， SVM）的高维特征排序方法。该方法通过线性 SVM 模型计算每个特征的权重，并根据特征权重对特征进行排序。基于线性 SVM 的特征排序方法在 Causality Challenge\cite{DBLP:journals/jmlr/GuyonACEPSS08}的数据集上已被证明有效。

Zien 等人\cite{Zien2009The}提出了特征重要性排序度量（Feature Importance Ranking Measure，FIRM）方法。该算法实现了一种通用的重要性度量，与基于权重的度量方法相比，该重要性度量方法不容易受特征缩放的影响，具有一定的客观性。

\subsubsection{变量重要性度量}

变量重要性度量从另外一个角度衡量特征排序。针对不同的数据集或问题类型，存在多种度量方法用于评估变量的重要性。

Shnaider 等人\cite{Shnaider2018Relative}提出基于传统方法与软回归的评估解释变量的相对重要性在逻辑回归（Logistic Regression）\cite{Thomas1998On}中。Pratt\cite{Mittlb2015Explained}提出的针对简单线性回归问题测量变量重要性的方法，在基础上\cite{Thomas1998On}进行了修改。

对于具有高维且未标记的特征的非线性问题，回归森林\cite{Breiman2001Random}\cite{Guyon2006An}可以用于进行特征排序。回归森林可以通过内部 out-of-bag 估计值提供两种变量重要性度量方法，即 Mean Decrease Accuracy （MDA）重要性评分方法及 Mean Decrease Gini （MDG）重要性评分方法，后者也被称为 Mean Decrease Impurity （MDI）方法。
Louppe 等人\cite{NIPS2013_4928}针对回归森林的 MDI 重要性评分方法进行了理论分析，并总结得到当且仅当变量不相关时，变量的 MDI 重要性等于零，并且相关变量的 MDI 重要性在去除或添加不相关变量的情况下均保持不变的结论。为了更好地反映变量的重要性，Strobl\cite{Strobl2008Conditional}等人提出了基于回归森林的条件变量重要性。该方法受到 Nason 等人\cite{Nason2004CARTscans}的启发，区分了变量的条件影响和边际影响。考虑到现实中数据包含缺失值的情况， Hapfelmeier 等人\cite{Hapfelmeier2014A}通过引入适用于任何类型数据的变量重要性度量方法，提出了克服数据缺失问题的解决方案。 Janitza 等人\cite{Janitza2013An}检验了在数据分布不平衡的情况下置换变量重要性的性能，并且使用基于AUC （AreaUnder Curve）的重要性度量方法来替换置换变量重要性度量，以达到更加稳健的重要性度量结果。

\section{本文主要工作}

本文将研究重点放在利用回归森林算法构建绘制系统模型后，针对全局性能瓶颈无法识别的情况，尝试采用不同的策略对特征空间进行合理的划分以识别出局部性能瓶颈。

\begin{itemize}
    \item 提出“特征空间划分方法”确定局部性能瓶颈

    针对无法在完整绘制性能数据集中找到全局性能瓶颈的复杂情况，提出特征空间超平面划分方法，完成对原绘制性能数据集的划分，旨在确定各子数据空间中的绘制性能瓶颈。各个子空间的性能瓶颈称为局部性能瓶颈。

    \item 完成对“瓶颈分析树”的设计以及量化评估

    不同策略的特征空间划分方法将导致不同的子数据空间划分结果，本文提出“瓶颈分析树”的概念描述数据空间的划分过程以及划分结果，并设计出相应的瓶颈分析树量化评标准，为进一步确定局部性能瓶颈提供基础。换言之：本文提出基于瓶颈分析树的特征空间划分方法。

	\item 两种策略构建瓶颈分析树

    设计实现了不同的性能瓶颈分析树生成策略，包括贪心算法策略和类遗传算法策略。重点研究类遗传算法策略，提出伪满二叉树的编码方式对瓶颈分析树进行编、解码任务，进一步完成基于遗传算法寻找更优瓶颈分析树的工作，改进了贪心算法策略中瓶颈分析树形态不稳定以及瓶颈分析树形态差的问题。

    \item 验证变量重要性计算对输入数据量的要求

    本文方法针对变量重要性计算过程中对预采集数据量敏感的现象，进行了进一步验证性工作。具体来说，当学习模型构建完成之后，利用该模型进行变量重要性计算时，用于计算的数据量小于一定阈值之后，所计算得到的变量重要性将不再具有指导意义，本文针对该特性进行具体阈值的验证性工作，以指导瓶颈分析树构建过程的改进。

	\item 构建并行化学习模型

    通过预采集性能数据集，实现基于回归森林算法的绘制性能评估模型并行构建过程，进一步完成以变量重要性为算法瓶颈度量标准的并行化实现过程；
\end{itemize}

\section{本文组织结构}

本文共分为五个章节，各章节的组织结构与核心内容如下：

第一章为绪论部分，主要介绍了本文研究课题的相关背景、现状以及研究意义，并针对识别复杂绘制系统算法级性能瓶颈中遇到的问题进行了阐述，最后对本文的研究内容以及解决的关键性问题进行说明。

第二章为相关技术部分，主要介绍了与本文算法相关的基础算法以及理论基础部分。主要介绍遗传算法、贪心算法的基本原理，以及基于回归森林变量重要性与瓶颈分析树的性能瓶颈识别技术其理论基础与大致实现流程。

第三章为核心算法部分，主要描述了本文基于特征空间划分思想构建瓶颈分析树以识别复杂绘制系统算法级性能瓶颈的实现，以及相关的算法推导，并详细阐述了实现中的难点以及具体细节。

第四章为实验部分，通过实验验证了本文算法的正确性、对比了本文算法中基于贪心策略的瓶颈分析树生成和基于类遗传策略的瓶颈分析树生成之间的具体改进点，从而验证后者的优势。

第五章为总结与展望，对本文基于特征空间划分的复杂绘制系统的优点和缺陷进行了分析，并针对存在的问题以及在此基础上的未来发展方向进行了展望。